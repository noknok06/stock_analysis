<!-- templates/notebooks/dashboard.html (æ”¹è‰¯ç‰ˆ) -->
{% extends 'base.html' %}

{% block title %}ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - æ ªå¼åˆ†æè¨˜éŒ²ã‚¢ãƒ—ãƒª{% endblock %}

{% block content %}
<div class="dashboard max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 md:py-6 space-y-4 md:space-y-6">
    <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="dashboard__header">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div class="dashboard__header-content">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-900">
                    <span role="img" aria-label="ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰">ğŸ“Š</span>
                    æ ªå¼åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                </h1>
                <p class="text-sm md:text-base text-gray-600 mt-1">
                    æŠ•è³‡åˆ¤æ–­ãƒ—ãƒ­ã‚»ã‚¹ã‚’è¨˜éŒ²ãƒ»è¿½è·¡ã—ã€æŠ•è³‡ã‚¹ã‚­ãƒ«ã‚’å‘ä¸Šã•ã›ã‚‹
                </p>
            </div>
            <div class="dashboard__header-actions flex items-center gap-2">
                <button class="app-btn app-btn--secondary app-btn--sm touch-friendly" aria-label="é€šçŸ¥">
                    <i data-lucide="bell" class="w-4 h-4" aria-hidden="true"></i>
                    <span class="hidden sm:inline">é€šçŸ¥</span>
                </button>
                <a href="{% url 'notebook_create' %}" class="app-btn app-btn--primary app-btn--sm">
                    <i data-lucide="plus" class="w-4 h-4" aria-hidden="true"></i>
                    <span class="hidden xs:inline">æ–°è¦ãƒãƒ¼ãƒˆ</span>
                    <span class="xs:hidden">æ–°è¦</span>
                </a>
            </div>
        </div>
    </header>

    <!-- ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³æ¤œç´¢ãƒãƒ¼ï¼ˆHub & Spoke ã®ä¸­å¿ƒæ©Ÿèƒ½ï¼‰ -->
    {% if user.is_authenticated %}
    <section class="dashboard__search" aria-labelledby="search-heading">
        <h2 id="search-heading" class="sr-only">æ¤œç´¢</h2>
        <div class="app-card">
            <div class="app-card__content p-3 md:p-4">
                <div class="search-container relative">
                    <label for="inline-search" class="sr-only">éŠ˜æŸ„åã€ã‚¿ã‚°ã€è¨˜éŒ²å†…å®¹ã‚’æ¤œç´¢</label>
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4 md:w-5 md:h-5" aria-hidden="true"></i>
                        <input 
                            type="text" 
                            id="inline-search"
                            placeholder="éŠ˜æŸ„åã€ã‚¿ã‚°ã€è¨˜éŒ²å†…å®¹ã‚’æ¤œç´¢..." 
                            class="app-input pl-10 md:pl-12 text-base md:text-lg h-12 md:h-14"
                            autocomplete="off"
                            role="combobox"
                            aria-expanded="false"
                            aria-owns="search-results"
                        />
                        
                        <!-- æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ -->
                        <div class="absolute right-3 top-1/2 transform -translate-y-1/2 flex items-center gap-2">
                            <label class="search-toggle flex items-center gap-1 text-xs md:text-sm text-gray-600">
                                <input type="checkbox" id="semantic-search-toggle" class="rounded" aria-describedby="search-mode-help">
                                <span>AIæ¤œç´¢</span>
                            </label>
                        </div>
                        
                        <!-- æ¤œç´¢ãƒ˜ãƒ«ãƒ— -->
                        <div id="search-mode-help" class="sr-only">
                            AIæ¤œç´¢ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€æ„å‘³çš„ã«é–¢é€£ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚‚æ¤œç´¢ã•ã‚Œã¾ã™
                        </div>
                    </div>
                    
                    <!-- åŸºæœ¬æ¤œç´¢çµæœ -->
                    <div id="search-results" 
                         class="search-results absolute top-full left-0 right-0 mt-2 bg-white border rounded-lg shadow-lg z-20 max-h-64 overflow-y-auto hidden"
                         role="listbox"
                         aria-label="æ¤œç´¢çµæœ">
                    </div>
                    
                    <!-- AIæ¤œç´¢çµæœ -->
                    <div id="semantic-results" 
                         class="search-results search-results--ai absolute top-full left-0 right-0 mt-2 bg-blue-50 border border-blue-200 rounded-lg shadow-lg z-20 max-h-80 overflow-y-auto hidden"
                         role="listbox"
                         aria-label="AIæ¤œç´¢çµæœ">
                        <div class="search-results__header p-3 border-b border-blue-200 bg-blue-100">
                            <div class="flex items-center gap-2 text-blue-800">
                                <i data-lucide="sparkles" class="w-4 h-4" aria-hidden="true"></i>
                                <span class="font-medium text-sm md:text-base">AIæ¤œç´¢çµæœ</span>
                            </div>
                        </div>
                        <div id="semantic-results-content" role="group" aria-label="AIæ¤œç´¢çµæœä¸€è¦§"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    {% endif %}

    <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
    <section class="dashboard__stats" aria-labelledby="stats-heading">
        <h2 id="stats-heading" class="sr-only">çµ±è¨ˆæƒ…å ±</h2>
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4">
            <div class="stats-card app-card">
                <div class="app-card__content p-3 md:p-4">
                    <div class="flex items-center justify-between">
                        <div class="stats-card__content">
                            <p class="text-xs md:text-sm text-gray-600">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒ¼ãƒˆ</p>
                            <p class="text-xl md:text-2xl font-bold text-gray-900">{{ stats.active_notebooks }}</p>
                            <p class="text-xs text-green-600 mt-1">+{{ stats.total_notebooks|add:"-5" }}</p>
                        </div>
                        <i data-lucide="book-open" class="w-6 h-6 md:w-8 md:h-8 text-blue-600" aria-hidden="true"></i>
                    </div>
                </div>
            </div>
            
            <div class="stats-card app-card">
                <div class="app-card__content p-3 md:p-4">
                    <div class="flex items-center justify-between">
                        <div class="stats-card__content">
                            <p class="text-xs md:text-sm text-gray-600">ä»Šæœˆã®è¨˜éŒ²</p>
                            <p class="text-xl md:text-2xl font-bold text-gray-900">{{ stats.monthly_entries }}</p>
                            <p class="text-xs text-green-600 mt-1">+5</p>
                        </div>
                        <i data-lucide="clock" class="w-6 h-6 md:w-8 md:h-8 text-blue-600" aria-hidden="true"></i>
                    </div>
                </div>
            </div>
            
            <div class="stats-card app-card">
                <div class="app-card__content p-3 md:p-4">
                    <div class="flex items-center justify-between">
                        <div class="stats-card__content">
                            <p class="text-xs md:text-sm text-gray-600">ç·ã‚¨ãƒ³ãƒˆãƒªãƒ¼</p>
                            <p class="text-xl md:text-2xl font-bold text-gray-900">{{ stats.total_entries }}</p>
                            <p class="text-xs text-green-600 mt-1">+12</p>
                        </div>
                        <i data-lucide="bar-chart-3" class="w-6 h-6 md:w-8 md:h-8 text-blue-600" aria-hidden="true"></i>
                    </div>
                </div>
            </div>
            
            <div class="stats-card app-card">
                <div class="app-card__content p-3 md:p-4">
                    <div class="flex items-center justify-between">
                        <div class="stats-card__content">
                            <p class="text-xs md:text-sm text-gray-600">ç›®æ¨™é”æˆç‡</p>
                            <p class="text-xl md:text-2xl font-bold text-gray-900">75%</p>
                            <p class="text-xs text-green-600 mt-1">+3%</p>
                        </div>
                        <i data-lucide="target" class="w-6 h-6 md:w-8 md:h-8 text-blue-600" aria-hidden="true"></i>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
    <div class="dashboard__content grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼ˆå·¦å´ãƒ»ä¸­å¤®ï¼‰ -->
        <div class="dashboard__main lg:col-span-2 space-y-4 md:space-y-6">
            <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
            <section class="dashboard__quick-actions" aria-labelledby="quick-actions-heading">
                <div class="app-card">
                    <div class="app-card__header">
                        <h2 id="quick-actions-heading" class="app-card__title">ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h2>
                    </div>
                    <div class="app-card__content">
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                            <a href="{% url 'notebook_create' %}" 
                               class="quick-action app-btn app-btn--secondary h-16 md:h-20 flex-col touch-friendly"
                               aria-describedby="new-notebook-desc">
                                <i data-lucide="plus" class="w-5 h-5 md:w-6 md:h-6 mb-1 md:mb-2" aria-hidden="true"></i>
                                <span class="text-xs md:text-sm">æ–°è¦ãƒãƒ¼ãƒˆ</span>
                            </a>
                            <div id="new-notebook-desc" class="sr-only">æ–°ã—ã„æŠ•è³‡ãƒãƒ¼ãƒˆã‚’ä½œæˆ</div>
                            
                            <a href="{% url 'calculator' %}" 
                               class="quick-action app-btn app-btn--secondary h-16 md:h-20 flex-col touch-friendly"
                               aria-describedby="calculator-desc">
                                <i data-lucide="calculator" class="w-5 h-5 md:w-6 md:h-6 mb-1 md:mb-2" aria-hidden="true"></i>
                                <span class="text-xs md:text-sm">è¨ˆç®—ãƒ„ãƒ¼ãƒ«</span>
                            </a>
                            <div id="calculator-desc" class="sr-only">é…å½“åˆ©å›ã‚Šã‚„æŠ•è³‡é‡‘é¡ã‚’è¨ˆç®—</div>
                            
                            <button class="quick-action app-btn app-btn--secondary h-16 md:h-20 flex-col touch-friendly"
                                    aria-describedby="stock-check-desc">
                                <i data-lucide="trending-up" class="w-5 h-5 md:w-6 md:h-6 mb-1 md:mb-2" aria-hidden="true"></i>
                                <span class="text-xs md:text-sm">æ ªä¾¡ãƒã‚§ãƒƒã‚¯</span>
                            </button>
                            <div id="stock-check-desc" class="sr-only">è¿½è·¡ä¸­éŠ˜æŸ„ã®æ ªä¾¡ã‚’ç¢ºèª</div>
                            
                            <button class="quick-action app-btn app-btn--secondary h-16 md:h-20 flex-col touch-friendly"
                                    aria-describedby="community-desc">
                                <i data-lucide="users" class="w-5 h-5 md:w-6 md:h-6 mb-1 md:mb-2" aria-hidden="true"></i>
                                <span class="text-xs md:text-sm">ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£</span>
                            </button>
                            <div id="community-desc" class="sr-only">ä»–ã®æŠ•è³‡å®¶ã¨çŸ¥è¦‹ã‚’å…±æœ‰</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- æœ€è¿‘ã®ãƒãƒ¼ãƒˆ -->
            {% if user.is_authenticated %}
            <section class="dashboard__recent-notes" aria-labelledby="recent-notes-heading">
                <div class="app-card">
                    <div class="app-card__header">
                        <h2 id="recent-notes-heading" class="app-card__title">æœ€è¿‘ã®è¨˜éŒ²</h2>
                    </div>
                    <div class="app-card__content">
                        {% if recent_notebooks %}
                            <div class="space-y-3 md:space-y-4">
                                {% for notebook in recent_notebooks %}
                                <article class="notebook-card border rounded-lg p-3 md:p-4 hover:bg-gray-50 cursor-pointer transition-colors" 
                                         data-notebook-id="{{ notebook.pk }}"
                                         tabindex="0"
                                         role="link"
                                         aria-labelledby="notebook-{{ notebook.pk }}-title"
                                         onclick="window.location.href='{% url 'notebook_detail' notebook.pk %}'"
                                         onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();window.location.href='{% url 'notebook_detail' notebook.pk %}'}">
                                    
                                    <div class="flex items-start justify-between gap-3">
                                        <div class="notebook-card__content flex-1 min-w-0">
                                            <h3 id="notebook-{{ notebook.pk }}-title" class="font-semibold text-base md:text-lg text-gray-900 truncate">
                                                {{ notebook.title }}
                                            </h3>
                                            {% if notebook.subtitle %}
                                                <p class="text-sm md:text-base text-gray-600 mt-1 line-clamp-2">{{ notebook.subtitle }}</p>
                                            {% endif %}
                                            
                                            <div class="notebook-card__meta flex flex-wrap items-center gap-2 md:gap-4 mt-2 text-xs md:text-sm text-gray-500">
                                                {% if notebook.current_price %}
                                                    <span class="flex items-center gap-1">
                                                        <i data-lucide="yen-sign" class="w-3 h-3" aria-hidden="true"></i>
                                                        ç¾åœ¨ä¾¡æ ¼: Â¥{{ notebook.current_price|floatformat:0 }}
                                                    </span>
                                                {% endif %}
                                                {% if notebook.target_price %}
                                                    <span class="flex items-center gap-1">
                                                        <i data-lucide="target" class="w-3 h-3" aria-hidden="true"></i>
                                                        ç›®æ¨™ä¾¡æ ¼: Â¥{{ notebook.target_price|floatformat:0 }}
                                                    </span>
                                                {% endif %}
                                                <span class="flex items-center gap-1">
                                                    <i data-lucide="file-text" class="w-3 h-3" aria-hidden="true"></i>
                                                    {{ notebook.entry_count }}ä»¶ã®è¨˜éŒ²
                                                </span>
                                            </div>
                                            
                                            <!-- ã‚¿ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                                            <div class="notebook-card__tags flex flex-wrap gap-1 mt-2">
                                                <!-- ã‚¿ã‚°ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                                            </div>
                                        </div>
                                        
                                        <div class="notebook-card__actions flex flex-col items-end gap-2">
                                            <time class="text-xs text-gray-500" datetime="{{ notebook.updated_at|date:'c' }}">
                                                {{ notebook.updated_at|timesince }}å‰
                                            </time>
                                            <div class="flex gap-1">
                                                <a href="{% url 'notebook_edit' notebook.pk %}" 
                                                   class="app-btn app-btn--ghost app-btn--sm p-1 touch-friendly"
                                                   aria-label="{{ notebook.title }}ã‚’ç·¨é›†"
                                                   onclick="event.stopPropagation()">
                                                    <i data-lucide="edit" class="w-4 h-4" aria-hidden="true"></i>
                                                </a>
                                                <a href="{% url 'entry_create' notebook.pk %}" 
                                                   class="app-btn app-btn--ghost app-btn--sm p-1 touch-friendly"
                                                   aria-label="{{ notebook.title }}ã«è¨˜éŒ²ã‚’è¿½åŠ "
                                                   onclick="event.stopPropagation()">
                                                    <i data-lucide="plus" class="w-4 h-4" aria-hidden="true"></i>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </article>
                                {% endfor %}
                            </div>
                            
                            <div class="mt-4">
                                <a href="{% url 'notebook_list' %}" class="app-btn app-btn--secondary w-full">
                                    ã™ã¹ã¦ã®ãƒãƒ¼ãƒˆã‚’è¦‹ã‚‹
                                    <i data-lucide="arrow-right" class="w-4 h-4 ml-2" aria-hidden="true"></i>
                                </a>
                            </div>
                        {% else %}
                            <div class="empty-state text-center py-8 md:py-12">
                                <i data-lucide="book-open" class="w-12 h-12 md:w-16 md:h-16 mx-auto mb-4 text-gray-300" aria-hidden="true"></i>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">ã¾ã ãƒãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</h3>
                                <p class="text-sm md:text-base text-gray-600 mb-4">æœ€åˆã®ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦åˆ†æã‚’å§‹ã‚ã¾ã—ã‚‡ã†</p>
                                <a href="{% url 'notebook_create' %}" class="app-btn app-btn--primary">
                                    <i data-lucide="plus" class="w-4 h-4" aria-hidden="true"></i>
                                    æœ€åˆã®ãƒãƒ¼ãƒˆã‚’ä½œæˆ
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </section>
            {% endif %}
        </div>

        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
        <aside class="dashboard__sidebar space-y-4 md:space-y-6">
            <!-- å¸‚å ´ãƒ‡ãƒ¼ã‚¿ -->
            <section class="market-summary" aria-labelledby="market-heading">
                <div class="app-card">
                    <div class="app-card__header">
                        <h2 id="market-heading" class="app-card__title">å¸‚å ´ã‚µãƒãƒªãƒ¼</h2>
                    </div>
                    <div class="app-card__content">
                        <div class="space-y-3">
                            {% for item in market_data %}
                            <div class="market-item flex items-center justify-between py-2 border-b last:border-b-0">
                                <span class="font-medium text-sm md:text-base">{{ item.name }}</span>
                                <div class="text-right">
                                    <div class="font-semibold text-sm md:text-base">{{ item.value }}</div>
                                    <div class="text-xs md:text-sm {% if '+' in item.change %}text-green-600{% else %}text-red-600{% endif %}">
                                        {{ item.change }} ({{ item.change_percent }})
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </section>

            <!-- äººæ°—ã‚¿ã‚° -->
            <section class="popular-tags" aria-labelledby="tags-heading">
                <div class="app-card">
                    <div class="app-card__header">
                        <h2 id="tags-heading" class="app-card__title">äººæ°—ã‚¿ã‚°</h2>
                    </div>
                    <div class="app-card__content">
                        <div class="flex flex-wrap gap-2">
                            {% for tag in popular_tags %}
                                <button class="app-badge app-badge--outline touch-friendly" 
                                        onclick="setSearchQuery('#{{ tag.name }}')"
                                        aria-label="{{ tag.name }}ã‚¿ã‚°ã§æ¤œç´¢">
                                    #{{ tag.name }}
                                </button>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </section>

            <!-- ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£æ´»å‹• -->
            <section class="community-activity" aria-labelledby="community-heading">
                <div class="app-card">
                    <div class="app-card__header">
                        <h2 id="community-heading" class="app-card__title">ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£</h2>
                    </div>
                    <div class="app-card__content">
                        <div class="space-y-3">
                            <article class="community-item">
                                <h3 class="font-medium text-sm md:text-base">è©±é¡Œã®éŠ˜æŸ„</h3>
                                <p class="text-xs md:text-sm text-gray-600">ãƒˆãƒ¨ã‚¿è‡ªå‹•è»Šã®æ±ºç®—åˆ†æãŒæ³¨ç›®ã•ã‚Œã¦ã„ã¾ã™</p>
                            </article>
                            <article class="community-item">
                                <h3 class="font-medium text-sm md:text-base">äººæ°—ã®æŠ•ç¨¿</h3>
                                <p class="text-xs md:text-sm text-gray-600">é«˜é…å½“æ ªã®é¸ã³æ–¹ã«ã¤ã„ã¦</p>
                            </article>
                            <button class="app-btn app-btn--secondary w-full app-btn--sm">
                                ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚’è¦‹ã‚‹
                                <i data-lucide="external-link" class="w-4 h-4 ml-2" aria-hidden="true"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </aside>
    </div>
</div>

<!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å°‚ç”¨JavaScript -->
<script>
    // ã‚¿ã‚°ã‹ã‚‰æ¤œç´¢å®Ÿè¡Œ
    function setSearchQuery(tag) {
        const searchInput = document.getElementById('inline-search');
        if (searchInput) {
            searchInput.value = tag;
            searchInput.focus();
            searchInput.dispatchEvent(new Event('input'));
        }
    }

    // é«˜åº¦ãªæ¤œç´¢æ©Ÿèƒ½ã®è¨­å®š
    function setupAdvancedSearch() {
        const searchInput = document.getElementById('inline-search');
        const searchResults = document.getElementById('search-results');
        const semanticResults = document.getElementById('semantic-results');
        const semanticToggle = document.getElementById('semantic-search-toggle');
        let searchTimeout;

        if (searchInput && searchResults) {
            // æ¤œç´¢å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const query = this.value.trim();
                
                if (query.length < 2) {
                    hideSearchResults();
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    if (semanticToggle && semanticToggle.checked) {
                        performSemanticSearch(query);
                    } else {
                        performBasicSearch(query);
                    }
                }, 300);
            });

            // æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
            if (semanticToggle) {
                semanticToggle.addEventListener('change', function() {
                    const query = searchInput.value.trim();
                    if (query.length >= 2) {
                        if (this.checked) {
                            performSemanticSearch(query);
                        } else {
                            performBasicSearch(query);
                        }
                    }
                });
            }

            // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
            searchInput.addEventListener('keydown', function(e) {
                const activeResults = getActiveSearchResults();
                if (!activeResults || activeResults.classList.contains('hidden')) return;

                const items = activeResults.querySelectorAll('[role="option"], a');
                let currentIndex = Array.from(items).findIndex(item => item.classList.contains('focused'));

                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        currentIndex = Math.min(currentIndex + 1, items.length - 1);
                        updateFocus(items, currentIndex);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        currentIndex = Math.max(currentIndex - 1, -1);
                        updateFocus(items, currentIndex);
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (currentIndex >= 0 && items[currentIndex]) {
                            items[currentIndex].click();
                        }
                        break;
                    case 'Escape':
                        hideSearchResults();
                        break;
                }
            });
            
            // å¤–éƒ¨ã‚¯ãƒªãƒƒã‚¯ã§çµæœã‚’é–‰ã˜ã‚‹
            document.addEventListener('click', function(e) {
                if (!isSearchRelated(e.target)) {
                    hideSearchResults();
                }
            });
        }
    }

    // åŸºæœ¬æ¤œç´¢å®Ÿè¡Œ
    function performBasicSearch(query) {
        fetch(`/api/search/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                displayBasicSearchResults(data.results);
                hideSemanticResults();
            })
            .catch(error => {
                console.error('æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                showSearchError('æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            });
    }

    // ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢å®Ÿè¡Œ
    function performSemanticSearch(query) {
        fetch(`/api/search/semantic/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displaySemanticSearchResults(data.results, query);
                    hideBasicResults();
                } else {
                    console.error('ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', data.error);
                    performBasicSearch(query);
                }
            })
            .catch(error => {
                console.error('ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                performBasicSearch(query);
            });
    }

    // åŸºæœ¬æ¤œç´¢çµæœè¡¨ç¤º
    function displayBasicSearchResults(results) {
        const searchResults = document.getElementById('search-results');
        const searchInput = document.getElementById('inline-search');
        
        if (results.length === 0) {
            searchResults.innerHTML = '<div class="p-4 text-center text-gray-500" role="option">æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“</div>';
        } else {
            searchResults.innerHTML = results.map((result, index) => `
                <a href="${result.url}" 
                   class="block p-3 hover:bg-gray-50 focus:bg-gray-50 border-b last:border-b-0 transition-colors"
                   role="option"
                   aria-describedby="result-${index}-desc"
                   tabindex="-1">
                    <div class="font-semibold text-sm md:text-base">${result.title}</div>
                    <div id="result-${index}-desc" class="text-xs md:text-sm text-gray-600">${result.subtitle}</div>
                    <div class="flex gap-1 mt-1">
                        ${result.tags.slice(0, 3).map(tag => 
                            `<span class="app-badge app-badge--outline text-xs">#${tag}</span>`
                        ).join('')}
                    </div>
                </a>
            `).join('');
        }
        
        searchResults.classList.remove('hidden');
        searchInput.setAttribute('aria-expanded', 'true');
    }

    // ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ¤œç´¢çµæœè¡¨ç¤º
    function displaySemanticSearchResults(results, query) {
        const semanticResults = document.getElementById('semantic-results');
        const semanticContent = document.getElementById('semantic-results-content');
        const searchInput = document.getElementById('inline-search');
        
        if (results.length === 0) {
            semanticContent.innerHTML = '<div class="p-4 text-center text-gray-500" role="option">AIæ¤œç´¢ã§é–¢é€£ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
        } else {
            semanticContent.innerHTML = results.map((result, index) => `
                <a href="${result.url}" 
                   class="block p-3 hover:bg-blue-100 focus:bg-blue-100 border-b border-blue-200 last:border-b-0 transition-colors"
                   role="option"
                   aria-describedby="ai-result-${index}-desc"
                   tabindex="-1">
                    <div class="flex items-start justify-between gap-3">
                        <div class="flex-1 min-w-0">
                            <div class="font-semibold text-sm md:text-base text-blue-900">${result.title}</div>
                            <div class="text-xs md:text-sm text-blue-700 mb-2">${result.subtitle}</div>
                            <div id="ai-result-${index}-desc" class="text-xs text-blue-600 bg-white p-2 rounded mb-2 line-clamp-2">
                                ${result.content_preview}
                            </div>
                            <div class="flex gap-1">
                                ${result.tags.slice(0, 3).map(tag => 
                                    `<span class="bg-blue-200 text-blue-800 px-2 py-1 rounded text-xs">#${tag}</span>`
                                ).join('')}
                            </div>
                        </div>
                        <div class="text-right ml-3">
                            <div class="text-xs text-blue-600 font-medium">
                                é–¢é€£åº¦: ${Math.round(result.relevance_score * 100)}%
                            </div>
                            <div class="text-xs text-blue-500">
                                ${result.entry_count}ä»¶ã®è¨˜éŒ²
                            </div>
                        </div>
                    </div>
                </a>
            `).join('');
        }
        
        semanticResults.classList.remove('hidden');
        searchInput.setAttribute('aria-expanded', 'true');
    }

    // æ¤œç´¢ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function showSearchError(message) {
        const searchResults = document.getElementById('search-results');
        searchResults.innerHTML = `
            <div class="p-4 text-center text-red-600" role="alert">
                <i data-lucide="alert-circle" class="w-5 h-5 mx-auto mb-2"></i>
                <div>${message}</div>
            </div>
        `;
        searchResults.classList.remove('hidden');
        lucide.createIcons();
    }

    // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function hideSearchResults() {
        const searchInput = document.getElementById('inline-search');
        hideBasicResults();
        hideSemanticResults();
        searchInput.setAttribute('aria-expanded', 'false');
    }

    function hideBasicResults() {
        const searchResults = document.getElementById('search-results');
        if (searchResults) {
            searchResults.classList.add('hidden');
        }
    }

    function hideSemanticResults() {
        const semanticResults = document.getElementById('semantic-results');
        if (semanticResults) {
            semanticResults.classList.add('hidden');
        }
    }

    function getActiveSearchResults() {
        const basicResults = document.getElementById('search-results');
        const semanticResults = document.getElementById('semantic-results');
        
        if (basicResults && !basicResults.classList.contains('hidden')) {
            return basicResults;
        }
        if (semanticResults && !semanticResults.classList.contains('hidden')) {
            return semanticResults;
        }
        return null;
    }

    function updateFocus(items, currentIndex) {
        items.forEach(item => item.classList.remove('focused'));
        if (currentIndex >= 0 && items[currentIndex]) {
            items[currentIndex].classList.add('focused');
            items[currentIndex].scrollIntoView({ block: 'nearest' });
        }
    }

    function isSearchRelated(element) {
        const searchContainer = element.closest('.search-container');
        const searchResults = element.closest('#search-results, #semantic-results');
        return searchContainer || searchResults;
    }

    // AIåˆ†æçµæœã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º
    function setupAIInsights() {
        const notebookElements = document.querySelectorAll('[data-notebook-id]');
        
        notebookElements.forEach(element => {
            const notebookId = element.dataset.notebookId;
            if (notebookId) {
                loadAIInsights(notebookId, element);
            }
        });
    }

    function loadAIInsights(notebookId, element) {
        fetch(`/api/insights/${notebookId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayAIInsights(data, element);
                }
            })
            .catch(error => {
                console.error('AIæ´å¯Ÿå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            });
    }

    function displayAIInsights(insights, element) {
        const aiIndicator = document.createElement('div');
        aiIndicator.className = 'absolute top-2 right-2 flex items-center gap-1';
        
        const depthColor = {
            'detailed': 'text-green-500',
            'moderate': 'text-yellow-500',
            'basic': 'text-gray-500'
        }[insights.categorization?.analysis_depth] || 'text-gray-500';
        
        aiIndicator.innerHTML = `
            <i data-lucide="brain" class="w-4 h-4 ${depthColor}" aria-hidden="true"></i>
            <span class="text-xs ${depthColor}" aria-label="AIåˆ†ææ·±åº¦: ${insights.categorization?.analysis_depth}">
                ${insights.categorization?.analysis_depth}
            </span>
        `;
        
        element.style.position = 'relative';
        element.appendChild(aiIndicator);
        
        if (insights.related_content?.length > 0) {
            const relatedIndicator = document.createElement('div');
            relatedIndicator.className = 'text-xs text-blue-600 mt-1';
            relatedIndicator.innerHTML = `
                <i data-lucide="link" class="w-3 h-3 inline" aria-hidden="true"></i> 
                é–¢é€£: ${insights.related_content.length}ä»¶
            `;
            element.appendChild(relatedIndicator);
        }
        
        lucide.createIcons();
    }

    // CSS line-clamp ã®ãƒãƒªãƒ•ã‚£ãƒ«ï¼ˆå¤ã„ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œï¼‰
    function setupLineClamp() {
        if (!CSS.supports('-webkit-line-clamp', '2')) {
            document.querySelectorAll('.line-clamp-2').forEach(element => {
                const lineHeight = parseInt(getComputedStyle(element).lineHeight);
                element.style.height = `${lineHeight * 2}px`;
                element.style.overflow = 'hidden';
            });
        }
    }

    // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
    function measurePerformance() {
        if ('performance' in window) {
            window.addEventListener('load', () => {
                const loadTime = performance.now();
                if (loadTime > 3000) {
                    console.warn('ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿æ™‚é–“ãŒé•·ã„ã§ã™:', loadTime, 'ms');
                }
            });
        }
    }

    // DOMãƒ­ãƒ¼ãƒ‰å¾Œã«å®Ÿè¡Œ
    document.addEventListener('DOMContentLoaded', function() {
        setupAdvancedSearch();
        setupAIInsights();
        setupLineClamp();
        measurePerformance();
    });
</script>

<!-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã®ãŸã‚ã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ -->
<link rel="preload" href="https://unpkg.com/lucide@latest/dist/umd/lucide.js" as="script">

<!-- æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ï¼ˆSEOãƒ»ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å‘ä¸Šï¼‰ -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "æ ªå¼åˆ†æè¨˜éŒ²ã‚¢ãƒ—ãƒª",
  "description": "æŠ•è³‡åˆ¤æ–­ãƒ—ãƒ­ã‚»ã‚¹ã‚’è¨˜éŒ²ãƒ»è¿½è·¡ã—ã€æŠ•è³‡ã‚¹ã‚­ãƒ«ã‚’å‘ä¸Šã•ã›ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³",
  "applicationCategory": "FinanceApplication",
  "operatingSystem": "Web Browser"
}
</script>
{% endblock %}