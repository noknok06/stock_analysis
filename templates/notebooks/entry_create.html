<!-- templates/notebooks/entry_create.html -->
{% extends 'base.html' %}

{% block title %}エントリー作成 - {{ notebook.title }} - 株式分析記録アプリ{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto p-4 space-y-6">
    <!-- ヘッダー -->
    <div class="flex items-center gap-4">
        <a href="{% url 'notebook_detail' notebook.pk %}" class="tw-btn-outline tw-btn-sm">
            <i data-lucide="arrow-left" class="w-4 h-4"></i>
            戻る
        </a>
        <div>
            <h1 class="text-2xl font-bold">新規エントリー作成</h1>
            <p class="text-gray-600">{{ notebook.title }}</p>
        </div>
    </div>

    <form method="post" class="space-y-6">
        {% csrf_token %}
        
        <!-- エントリー情報 -->
        <div class="tw-card">
            <div class="tw-card-header">
                <h2 class="tw-card-title">エントリー情報</h2>
            </div>
            <div class="tw-card-content space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">エントリータイプ</label>
                    {{ form.entry_type }}
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">タイトル</label>
                    {{ form.title }}
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">内容</label>
                    {{ form.content }}
                    <div class="text-xs text-gray-500 mt-1">
                        20文字以上入力するとAIによるリアルタイム分析が開始されます
                    </div>
                </div>
            </div>
        </div>

        <!-- AI分析支援 -->
        <div class="tw-card border-blue-200 bg-blue-50" id="ai-analysis-panel" style="display: none;">
            <div class="tw-card-header">
                <h2 class="tw-card-title flex items-center gap-2 text-blue-900">
                    <i data-lucide="sparkles" class="w-5 h-5"></i>
                    リアルタイムAI分析
                </h2>
            </div>
            <div class="tw-card-content space-y-4">
                <!-- 自動分類結果 -->
                <div class="bg-white rounded-lg p-3">
                    <h3 class="font-medium text-blue-800 mb-2">自動分類</h3>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div>
                            <span class="text-gray-600">投資戦略:</span>
                            <span class="ml-1 font-medium" id="auto-investment-strategy">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">コンテンツ種別:</span>
                            <span class="ml-1 font-medium" id="auto-content-type">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">分析深度:</span>
                            <span class="ml-1 font-medium" id="auto-analysis-depth">-</span>
                        </div>
                        <div>
                            <span class="text-gray-600">信頼度:</span>
                            <span class="ml-1 font-medium" id="auto-confidence">-</span>
                        </div>
                    </div>
                </div>

                <!-- AI推奨タグ -->
                <div class="bg-white rounded-lg p-3">
                    <h3 class="font-medium text-blue-800 mb-2">AI推奨タグ</h3>
                    <div id="ai-recommended-tags" class="flex flex-wrap gap-2">
                        <!-- AIタグがここに動的に追加される -->
                    </div>
                </div>

                <!-- 推奨アクション -->
                <div class="bg-white rounded-lg p-3" id="auto-recommended-actions">
                    <h3 class="font-medium text-blue-800 mb-2">推奨アクション</h3>
                    <div id="auto-actions-list" class="space-y-1 text-sm">
                        <!-- 推奨アクションがここに動的に追加される -->
                    </div>
                </div>

                <!-- 分析スコア -->
                <div class="bg-white rounded-lg p-3">
                    <h3 class="font-medium text-blue-800 mb-2">分析スコア</h3>
                    <div class="flex items-center gap-2">
                        <div class="flex-1 bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" id="auto-analysis-score-bar" style="width: 0%"></div>
                        </div>
                        <span class="text-sm font-medium" id="auto-analysis-score-text">0</span>
                    </div>
                </div>

                <!-- 自動エントリータイプ設定 -->
                <div class="bg-white rounded-lg p-3">
                    <h3 class="font-medium text-blue-800 mb-2">AI推奨設定</h3>
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-gray-600">エントリータイプ自動設定</span>
                        <button type="button" id="apply-auto-type" class="tw-btn-outline tw-btn-sm" style="display: none;">
                            <i data-lucide="wand-2" class="w-3 h-3"></i>
                            適用
                        </button>
                    </div>
                    <div class="text-xs text-gray-500 mt-1" id="auto-type-suggestion">
                        <!-- 推奨エントリータイプがここに表示される -->
                    </div>
                </div>
            </div>
        </div>

        <!-- タグ -->
        <div class="tw-card">
            <div class="tw-card-header">
                <h2 class="tw-card-title flex items-center gap-2">
                    <i data-lucide="tag" class="w-5 h-5"></i>
                    タグ
                </h2>
            </div>
            <div class="tw-card-content space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">タグ</label>
                    {{ form.tags }}
                </div>

                <!-- おすすめタグ -->
                <div>
                    <label class="block text-sm text-gray-600 mb-2">おすすめタグ</label>
                    <div class="flex flex-wrap gap-2">
                        <span class="tw-badge-outline cursor-pointer" onclick="addSuggestedTag('決算分析')">
                            #決算分析
                        </span>
                        <span class="tw-badge-outline cursor-pointer" onclick="addSuggestedTag('業績好調')">
                            #業績好調
                        </span>
                        <span class="tw-badge-outline cursor-pointer" onclick="addSuggestedTag('テクニカル')">
                            #テクニカル
                        </span>
                        <span class="tw-badge-outline cursor-pointer" onclick="addSuggestedTag('ファンダメンタル')">
                            #ファンダメンタル
                        </span>
                        <span class="tw-badge-outline cursor-pointer" onclick="addSuggestedTag('配当計算')">
                            #配当計算
                        </span>
                        <span class="tw-badge-outline cursor-pointer" onclick="addSuggestedTag('リスク分析')">
                            #リスク分析
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 保存ボタン -->
        <div class="flex justify-end gap-3">
            <a href="{% url 'notebook_detail' notebook.pk %}" class="tw-btn-outline">
                キャンセル
            </a>
            <button type="submit" class="tw-btn-primary">
                <i data-lucide="save" class="w-4 h-4"></i>
                保存
            </button>
        </div>
    </form>
</div>

<script>
    function addSuggestedTag(tag) {
        const tagsInput = document.getElementById('id_tags');
        const currentTags = tagsInput.value.split(',').map(t => t.trim()).filter(t => t);
        
        if (!currentTags.includes(tag)) {
            currentTags.push(tag);
            tagsInput.value = currentTags.join(', ');
        }
    }

    // リアルタイムAI分析の設定
    function setupRealtimeAIAnalysis() {
        const contentField = document.getElementById('id_content');
        const titleField = document.getElementById('id_title');
        const typeField = document.getElementById('id_entry_type');
        const aiPanel = document.getElementById('ai-analysis-panel');
        
        let analysisTimeout;
        let lastAnalyzedContent = '';
        let currentRecommendedType = '';

        function triggerAnalysis() {
            clearTimeout(analysisTimeout);
            
            const content = contentField.value.trim();
            const title = titleField ? titleField.value.trim() : '';
            
            // 最小文字数チェック
            if (content.length < 20) {
                aiPanel.style.display = 'none';
                return;
            }
            
            // 前回と同じ内容の場合はスキップ
            if (content === lastAnalyzedContent) {
                return;
            }
            
            analysisTimeout = setTimeout(() => {
                performRealtimeAnalysis(content, title);
                lastAnalyzedContent = content;
            }, 1000);
        }

        // イベントリスナー設定
        if (contentField) {
            contentField.addEventListener('input', triggerAnalysis);
        }
        if (titleField) {
            titleField.addEventListener('input', triggerAnalysis);
        }
        if (typeField) {
            typeField.addEventListener('change', triggerAnalysis);
        }

        // 自動タイプ適用ボタン
        const applyAutoTypeBtn = document.getElementById('apply-auto-type');
        if (applyAutoTypeBtn) {
            applyAutoTypeBtn.addEventListener('click', function() {
                if (currentRecommendedType) {
                    typeField.value = currentRecommendedType;
                    this.style.display = 'none';
                    
                    // 視覚的フィードバック
                    const suggestion = document.getElementById('auto-type-suggestion');
                    suggestion.innerHTML = '✓ エントリータイプを適用しました';
                    suggestion.className = 'text-xs text-green-600 mt-1';
                }
            });
        }
    }

    // リアルタイム分析実行
    function performRealtimeAnalysis(content, title) {
        // 基本AI分析
        fetch('/api/ai/analyze/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                content: content,
                title: title
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 自動分類分析
                return fetch('/api/ai/categorize/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({
                        content: content,
                        title: title
                    })
                }).then(response => response.json())
                .then(categorizationData => {
                    if (categorizationData.success) {
                        displayRealtimeAnalysis(data.analysis, categorizationData.categorization);
                    }
                });
            }
        })
        .catch(error => {
            console.error('リアルタイム分析エラー:', error);
        });
    }

    // リアルタイム分析結果表示
    function displayRealtimeAnalysis(analysis, categorization) {
        const aiPanel = document.getElementById('ai-analysis-panel');
        
        // パネル表示
        aiPanel.style.display = 'block';
        
        // 自動分類結果表示
        displayAutoCategorization(categorization);
        
        // AI推奨タグ表示
        displayAIRecommendedTags(analysis.suggested_tags);
        
        // 推奨アクション表示
        displayAutoRecommendedActions(categorization.recommended_actions);
        
        // 分析スコア表示
        displayAutoAnalysisScore(analysis.analysis_score);
        
        // エントリータイプ推奨
        suggestEntryType(categorization.content_type);
        
        // アイコン再初期化
        lucide.createIcons();
    }

    function displayAutoCategorization(categorization) {
        const strategyLabels = {
            'dividend_income': '配当収入',
            'growth_investing': '成長投資',
            'value_investing': 'バリュー投資',
            'short_term_trading': '短期取引',
            'long_term_holding': '長期保有',
            'diversified': '分散投資'
        };
        
        const depthLabels = {
            'detailed': '詳細',
            'moderate': '中程度',
            'basic': '基本'
        };
        
        const typeLabels = {
            'earnings_analysis': '決算分析',
            'news_analysis': 'ニュース分析',
            'technical_analysis': 'テクニカル分析',
            'fundamental_analysis': 'ファンダメンタル分析',
            'calculation': '計算',
            'risk_analysis': 'リスク分析',
            'general_memo': '一般メモ'
        };
        
        document.getElementById('auto-investment-strategy').textContent = 
            strategyLabels[categorization.investment_strategy] || categorization.investment_strategy;
        document.getElementById('auto-content-type').textContent = 
            typeLabels[categorization.content_type] || categorization.content_type;
        document.getElementById('auto-analysis-depth').textContent = 
            depthLabels[categorization.analysis_depth] || categorization.analysis_depth;
        document.getElementById('auto-confidence').textContent = 
            Math.round(categorization.classification_confidence * 100) + '%';
    }

    function displayAIRecommendedTags(suggestedTags) {
        const container = document.getElementById('ai-recommended-tags');
        
        container.innerHTML = suggestedTags.map(tag => `
            <span class="tw-badge-outline cursor-pointer hover:bg-blue-200 transition-colors" 
                  onclick="addAITag('${tag}')">
                ${tag}
            </span>
        `).join('');
    }

    function displayAutoRecommendedActions(actions) {
        const container = document.getElementById('auto-actions-list');
        
        if (!actions || actions.length === 0) {
            container.innerHTML = '<div class="text-gray-500">推奨アクションはありません</div>';
            return;
        }
        
        container.innerHTML = actions.map(action => `
            <div class="flex items-start gap-2">
                <i data-lucide="arrow-right" class="w-3 h-3 text-blue-600 mt-0.5 flex-shrink-0"></i>
                <span>${action}</span>
            </div>
        `).join('');
    }

    function displayAutoAnalysisScore(score) {
        const scoreBar = document.getElementById('auto-analysis-score-bar');
        const scoreText = document.getElementById('auto-analysis-score-text');
        
        scoreBar.style.width = `${score}%`;
        scoreText.textContent = score;
        
        // スコアによる色分け
        if (score >= 80) {
            scoreBar.className = 'bg-green-600 h-2 rounded-full transition-all duration-300';
        } else if (score >= 50) {
            scoreBar.className = 'bg-yellow-500 h-2 rounded-full transition-all duration-300';
        } else {
            scoreBar.className = 'bg-red-500 h-2 rounded-full transition-all duration-300';
        }
    }

    function addAITag(tag) {
        const tagsInput = document.getElementById('id_tags');
        const currentTags = tagsInput.value.split(',').map(t => t.trim()).filter(t => t);
        
        if (!currentTags.includes(tag)) {
            currentTags.push(tag);
            tagsInput.value = currentTags.join(', ');
            
            // 視覚的フィードバック
            event.target.classList.add('bg-blue-200');
            setTimeout(() => {
                event.target.classList.remove('bg-blue-200');
            }, 500);
        }
    }

    function suggestEntryType(contentType) {
        const typeField = document.getElementById('id_entry_type');
        const suggestion = document.getElementById('auto-type-suggestion');
        const applyBtn = document.getElementById('apply-auto-type');
        
        const typeMapping = {
            'earnings_analysis': { value: 'earnings', label: '決算情報' },
            'news_analysis': { value: 'news', label: 'ニュース' },
            'technical_analysis': { value: 'analysis', label: '分析' },
            'fundamental_analysis': { value: 'analysis', label: '分析' },
            'calculation': { value: 'calculation', label: '計算結果' },
            'risk_analysis': { value: 'analysis', label: '分析' },
            'general_memo': { value: 'memo', label: 'メモ' }
        };
        
        const mappedType = typeMapping[contentType];
        if (mappedType && typeField.value !== mappedType.value) {
            currentRecommendedType = mappedType.value;
            suggestion.innerHTML = `推奨: ${mappedType.label}`;
            suggestion.className = 'text-xs text-blue-600 mt-1';
            applyBtn.style.display = 'inline-flex';
        } else {
            suggestion.innerHTML = '現在の設定が適切です';
            suggestion.className = 'text-xs text-green-600 mt-1';
            applyBtn.style.display = 'none';
        }
    }

    // ショートカットキー
    function setupShortcuts() {
        document.addEventListener('keydown', function(e) {
            // Ctrl + Enter で保存
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                document.querySelector('form').submit();
            }
            
            // Ctrl + T でタグフィールドにフォーカス
            if ((e.ctrlKey || e.metaKey) && e.key === 't') {
                e.preventDefault();
                document.getElementById('id_tags').focus();
            }
        });
    }

    // フォームバリデーション強化
    function setupFormValidation() {
        const form = document.querySelector('form');
        const contentField = document.getElementById('id_content');
        
        form.addEventListener('submit', function(e) {
            if (contentField.value.trim().length < 10) {
                e.preventDefault();
                alert('内容は10文字以上入力してください');
                contentField.focus();
                return false;
            }
        });
    }

    // DOMロード後に実行
    document.addEventListener('DOMContentLoaded', function() {
        setupRealtimeAIAnalysis();
        setupShortcuts();
        setupFormValidation();
    });
</script>
{% endblock %}